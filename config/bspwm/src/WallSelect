#!/bin/sh
# WallSelect: static + animated (mp4/mkv/gif) из текущей темы
# Зависимости: rofi, feh, ffmpeg (для превью видео), (опц.) imagemagick

set -eu

# Текущая тема и директории
read -r current_rice <"$HOME/.config/bspwm/.rice"
wall_dir="$HOME/.config/bspwm/rices/$current_rice/walls"
cache_dir="$HOME/.cache/$USER/wallselect"
mkdir -p "$cache_dir"

# Rofi команда/тема
rofi_cmd="rofi -dmenu -theme $HOME/.config/bspwm/src/rofi-themes/WallSelect.rasi"

# Быстрая проверка расширений
is_video() {
  case "${1##*.}" in
    mp4|MP4|mkv|MKV|gif|GIF) return 0 ;;
    *) return 1 ;;
  esac
}

# Мини-превью для видео/гиф (1 кадр, 500x500)
thumb_for() {
  in="$1"
  base="$(basename "$in")"
  out="$cache_dir/$base.jpg"
  [ -f "$out" ] && { printf %s "$out"; return; }
  command -v ffmpeg >/dev/null 2>&1 || { printf %s "$in"; return; }
  ffmpeg -loglevel error -y -i "$in" -vframes 1 \
    -vf "scale=500:500:force_original_aspect_ratio=decrease,pad=500:500:(ow-iw)/2:(oh-ih)/2" \
    "$out" >/dev/null 2>&1 || true
  printf %s "${out:-$in}"
}

# Сформировать список для rofi (исключая lockscreen.*)
# (иконка = сам файл для изображений, или превью для видео)
menu_stream() {
  find "$wall_dir" -maxdepth 1 -type f \
    \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' -o -iname '*.mp4' -o -iname '*.mkv' -o -iname '*.gif' \) \
    -not -iname 'lockscreen.*' \
    -printf '%f\0' \
  | xargs -0 -I{} sh -c '
      name="$1"
      full="'"$wall_dir"'/$name"
      if '"$(printf 'false;')"' ; then :; fi
      if '"$(printf 'true;')"' ; then :; fi
      # Выбор иконки
      case "$name" in
        *.mp4|*.MP4|*.mkv|*.MKV|*.gif|*.GIF)
          icon="$(thumb_for "$full")"
          ;;
        *)
          icon="$full"
          ;;
      esac
      printf "%s\000icon\037%s\n" "$name" "$icon"
  ' sh {}
}

# Показать меню и получить выбор
selection="$(menu_stream | $rofi_cmd || true)"

[ -z "${selection:-}" ] && exit 0

full_path="$wall_dir/$selection"

# Сброс старого анимированного фона (если был)
pkill xwinwrap >/dev/null 2>&1 || true

# Установка фона
if is_video "$selection"; then
  AnimatedWall --start "$full_path"
else
  feh --no-fehbg --bg-fill "$full_path"
fi
