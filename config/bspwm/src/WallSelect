#!/bin/sh
# WallSelect: статика + mp4/mkv/gif из текущей темы (без lockscreen.*)

# --- настройки ---
read -r current_rice <"$HOME/.config/bspwm/.rice"
wall_dir="$HOME/.config/bspwm/rices/$current_rice/walls"
cache_dir="$HOME/.cache/$USER/wallselect"
rofi_cmd="rofi -dmenu -theme $HOME/.config/bspwm/src/rofi-themes/WallSelect.rasi"
mkdir -p "$cache_dir"

is_video() {
  case "${1##*.}" in mp4|MP4|mkv|MKV|gif|GIF) return 0;; *) return 1;; esac
}

thumb_for() {
  in="$1"; base="$(basename "$in")"; out="$cache_dir/$base.png"
  [ -f "$out" ] && { printf %s "$out"; return; }
  command -v ffmpeg >/dev/null 2>&1 || { printf %s "$in"; return; }

  # 1 кадр -> вписываем в 500x500 с сохранением пропорций
  # прозрачные поля через color=black@0, выход RGBA
  ffmpeg -loglevel error -y -i "$in" -vframes 1 \
    -vf "scale=500:500:force_original_aspect_ratio=decrease,\
pad=500:500:(ow-iw)/2:(oh-ih)/2:color=black@0,\
format=rgba" \
    -c:v png -pix_fmt rgba "$out" >/dev/null 2>&1 || true

  printf %s "$out"
}



# --- наполняем меню ---
menu_stream() {
  find "$wall_dir" -maxdepth 1 -type f \
    \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' -o -iname '*.mp4' -o -iname '*.mkv' -o -iname '*.gif' \) \
    -not -iname 'lockscreen.*' -print0 \
  | sort -z \
  | while IFS= read -r -d '' file; do
      name="$(basename "$file")"
      if is_video "$name"; then icon="$(thumb_for "$file")"; else icon="$file"; fi
      printf '%s\000icon\037%s\n' "$name" "$icon"
    done
}

selection="$(menu_stream | $rofi_cmd || true)"
[ -z "$selection" ] && exit 0

full="$wall_dir/$selection"
pkill xwinwrap >/dev/null 2>&1 || true
if is_video "$selection"; then
  AnimatedWall --start "$full"
else
  feh --no-fehbg --bg-fill "$full"
fi
